<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pregunta - {{categoria}}</title>
    <link rel="stylesheet" href="../public/styles/preguntaStyle.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

<div class="pregunta-container">

    <div id="timerBox" class="timer">Tiempo <h2 id="timer">{{tiempo_restante}}</h2></div>

    <h2 class="categoria-titulo">CategorÃ­a: {{categoria}}</h2>

    <div class="pregunta-box">
        <h3 class="pregunta-text">{{pregunta.pregunta}}</h3>
    </div>

    <form class="opciones-container" method="POST">

        <input type="hidden" name="id_pregunta" value="{{pregunta.id}}">

        <button type="button" class="opcion-btn" value="A">{{pregunta.opcion_a}}</button>
        <button type="button" class="opcion-btn" value="B">{{pregunta.opcion_b}}</button>
        <button type="button" class="opcion-btn" value="C">{{pregunta.opcion_c}}</button>
        <button type="button" class="opcion-btn" value="D">{{pregunta.opcion_d}}</button>

    </form>
</div>


<!-- MODAL RESULTADO -->
<div class="modal fade" id="resultadoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">

            <div class="modal-header">
                <h5 class="modal-title">Resultado</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <h3 id="mensajeResultado" class="fw-bold"></h3>
            </div>

            <div class="modal-footer">
                <a href="/partida/ruleta" class="btn btn-primary">Volver a girar</a>
            </div>

        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script>

    const partidaId = Number("{{partida_id}}");

    // 1. Insertar estado actual en el historial
    history.pushState({page: "partida"}, "", window.location.href);

    // 2. Detectar "atrÃ¡s"
    window.addEventListener("popstate", function (event) {

        fetch("/partida/marcarAbandono", { method: "POST", body: `partidaId=${partidaId}` })
                .finally(() => window.location.href = "/partida/resumen?partidaId=" + partidaId);
    });

    let tiempo = Number("{{tiempo_restante}}") || 0;

    const timerElem = document.getElementById("timer");
    const timerBox = document.getElementById("timerBox");

    let intervalo = setInterval(() => {
        tiempo--;
        timerElem.textContent = tiempo;

        if (tiempo <= 5) timerBox.style.color = "red";

        if (tiempo <= 0) {
            clearInterval(intervalo);

            // Aviso visual opcional
            timerElem.textContent = "0";

            // Forzar verificaciÃ³n al backend
            const idTimeout = document.querySelector("input[name='id_pregunta']").value;
            fetch("/partida/responder", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `id_pregunta=${encodeURIComponent(idTimeout)}&respuesta=timeout`
            })
                    .then(res => res.json())
                    .then(data => {
                        if (data.partidaFinalizada) {
                            window.location.href = "/partida/resumen?partidaId=" + partidaId;
                        }
                    });
        }

    }, 1000);

    document.querySelectorAll(".opcion-btn").forEach(btn => {
        btn.addEventListener("click", function (e) {
            e.preventDefault();
            clearInterval(intervalo); // <--- cortar el timer al responder

            const respuesta = this.value;
            const id = document.querySelector("input[name='id_pregunta']").value;

            fetch("/partida/responder", {
                method: "POST",
                headers: {"Content-Type": "application/x-www-form-urlencoded"},
                body: `id_pregunta=${id}&respuesta=${respuesta}`
            })
                    .then(res => res.json())
                    .then(data => {
                        const modal = new bootstrap.Modal(document.getElementById("resultadoModal"));
                        const mensaje = document.getElementById("mensajeResultado");

                        if (data.correcta) {

                            mensaje.innerHTML = "ðŸŽ‰ Â¡Respuesta correcta!";
                            mensaje.classList.add("text-success");
                            mensaje.classList.remove("text-danger");

                        }  if (data.error){

                            mensaje.innerHTML = "Â¡Ya respondiste!";
                            mensaje.classList.add("text-success");
                            mensaje.classList.remove("text-danger");

                        } else if (data.partidaFinalizada) {

                            window.location.href = "/partida/resumen?partidaId=" + data.partidaId;
                        }

                        modal.show();
                    });

        });
    });


</script>

</body>
</html>

