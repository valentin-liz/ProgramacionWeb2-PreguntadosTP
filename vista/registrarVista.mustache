<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Registrarse</title>
    <link rel="stylesheet" href="../public/styles/registrarStyle.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>

<h1 class="fw-bold text-center mt-5 mb-4">Registrarse</h1>

{{#errorFaltanDatos}}
<div class="alert alert-warning">{{errorFaltanDatos}}</div>
{{/errorFaltanDatos}}

{{#errorUsuarioYaExiste}}
<div class="alert alert-danger">{{errorUsuarioYaExiste}}</div>
{{/errorUsuarioYaExiste}}

{{#errorAlRegistrar}}
<div class="alert alert-danger">{{errorAlRegistrar}}</div>
{{/errorAlRegistrar}}

{{#errorEmailFalso}}
<div class="alert alert-danger">{{errorEmailFalso}}</div>
{{/errorEmailFalso}}

{{#exito}}
<div class="alert alert-success">{{exito}}</div>
{{/exito}}

<div class="containerForm">

    <form method="post" enctype="multipart/form-data">

        <label class="form-label">Nombre</label>
        <input class="form-control" type="text" name="nombre" required>

        <label class="form-label">Apellido</label>
        <input class="form-control" type="text" name="apellido" required>

        <label class="form-label">Año de nacimiento</label>
        <input class="form-control" type="number" name="anio_nacimiento" min="1900" max="2025" required>

        <label class="form-label">Sexo</label>
        <div class="radio-group">
            <label><input type="radio" name="sexo" value="Masculino" checked> Masculino</label>
            <label><input type="radio" name="sexo" value="Femenino"> Femenino</label>
            <label><input type="radio" name="sexo" value="Prefiero no cargarlo"> Prefiero no cargarlo</label>
        </div>

        <!-- Mapa -->
        <label class="form-label">Elegir ubicación</label>

        <div id="map" style="height: 300px; border-radius: 10px; margin-bottom: 10px;"></div>

        <input class="form-control" type="text" id="pais_ciudad" name="pais_ciudad"
            placeholder="Escribí país o ciudad o hacé clic en el mapa">

        <label class="form-label">Email</label>
        <input class="form-control" type="email" name="email" required>

        <label class="form-label">Nombre de usuario</label>
        <input class="form-control" type="text" name="usuario" required>

        <label class="form-label">Contraseña</label>
        <input class="form-control" type="password" name="contrasenia" required>

        <label class="form-label">Foto de perfil</label>
        <input class="form-control" type="file" name="foto_perfil" accept="image/*">

        <button class="btn btn-primary mt-4 mb-4" type="submit">Registrarse</button>

        <div class="text-center">
            <a class="link" href="/login/login">¿Ya tenés cuenta? Inicia sesión</a>
        </div>

    </form>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ====================
// Inicializar mapa
// ====================
const map = L.map('map').setView([-34.61, -58.38], 4);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
}).addTo(map);

let marker = null;

// Función que pone el marcador en el mapa
function setMarker(lat, lng) {
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map);
}

// ====================
// CLICK EN EL MAPA
// ====================
map.on('click', async function (e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    setMarker(lat, lng);

    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
    const res = await fetch(url);
    const data = await res.json();

    let pais = data.address?.country || "";
    let ciudad =
        data.address?.city ||
        data.address?.town ||
        data.address?.village ||
        "";

    document.getElementById("pais_ciudad").value = pais + " - " + ciudad;
});

// ====================
// AUTOCOMPLETAR AL ESCRIBIR
// ====================
const input = document.getElementById("pais_ciudad");
let escribirTimer = null;

input.addEventListener("input", function () {
    clearTimeout(escribirTimer);

    const texto = input.value.trim();
    if (texto.length < 3) return;

    // Esperar 500ms para evitar spam
    escribirTimer = setTimeout(() => buscarUbicacion(texto), 500);
});

// Buscar ubicación por texto
async function buscarUbicacion(texto) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(texto)}&limit=1`;

    const res = await fetch(url);
    const data = await res.json();

    if (data.length === 0) return; // No encontró nada

    const lat = parseFloat(data[0].lat);
    const lon = parseFloat(data[0].lon);

    // Mover mapa + marcador
    map.setView([lat, lon], 10);
    setMarker(lat, lon);

    // Obtener país y ciudad exactos
    const urlReverse = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
    const resRev = await fetch(urlReverse);
    const dataRev = await resRev.json();

    let pais = dataRev.address?.country || "";
    let ciudad =
        dataRev.address?.city ||
        dataRev.address?.town ||
        dataRev.address?.village ||
        "";

    input.value = pais + " - " + ciudad;
}
</script>

</body>
</html>

