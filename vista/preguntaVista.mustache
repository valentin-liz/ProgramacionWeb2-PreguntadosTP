<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pregunta - {{categoria}}</title>
    <link rel="stylesheet" href="../public/styles/preguntaStyle.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

<div class="pregunta-container">
    <h2 class="categoria-titulo">CategorÃ­a: {{categoria}}</h2>

    <div class="pregunta-box">
        <h3 class="pregunta-text">{{pregunta.pregunta}}</h3>
    </div>

    <form class="opciones-container" method="POST">

        <input type="hidden" name="id_pregunta" value="{{pregunta.id}}">

        <button type="button" class="opcion-btn" value="A">{{pregunta.opcion_a}}</button>
        <button type="button" class="opcion-btn" value="B">{{pregunta.opcion_b}}</button>
        <button type="button" class="opcion-btn" value="C">{{pregunta.opcion_c}}</button>
        <button type="button" class="opcion-btn" value="D">{{pregunta.opcion_d}}</button>

    </form>
</div>


<!-- MODAL RESULTADO -->
<div class="modal fade" id="resultadoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">

            <div class="modal-header">
                <h5 class="modal-title">Resultado</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <h3 id="mensajeResultado" class="fw-bold"></h3>
            </div>

            <div class="modal-footer">
                <a href="/partida/ruleta" class="btn btn-primary">Volver a girar</a>
            </div>

        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script>

    window.addEventListener("beforeunload", function (event) {
        // Si la nueva URL NO inicia con tu dominio â†’ abandono real
        const nextUrl = document.activeElement?.href;

        if (!nextUrl || !nextUrl.startsWith(window.location.origin)) {
            navigator.sendBeacon("/partida/marcarAbandono");
        }
    });



    document.querySelectorAll(".opcion-btn").forEach(btn => {
        btn.addEventListener("click", function (e) {
            e.preventDefault();

            const respuesta = this.value;
            const id = document.querySelector("input[name='id_pregunta']").value;

            fetch("/partida/responder", {
                method: "POST",
                headers: {"Content-Type": "application/x-www-form-urlencoded"},
                body: `id_pregunta=${id}&respuesta=${respuesta}`
            })
                    .then(res => res.json())
                    .then(data => {
                        const modal = new bootstrap.Modal(document.getElementById("resultadoModal"));
                        const mensaje = document.getElementById("mensajeResultado");

                        if (data.correcta) {

                            mensaje.innerHTML = "ðŸŽ‰ Â¡Respuesta correcta!";
                            mensaje.classList.add("text-success");
                            mensaje.classList.remove("text-danger");

                        } else if (data.partidaFinalizada) {

                            window.location.href = "/partida/resumen?partidaId=" + data.partidaId;
                        }

                        modal.show();
                    });
        });
    });
</script>

</body>
</html>

